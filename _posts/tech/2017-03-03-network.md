---
layout: post
title: 网络协议总结
excerpt: TCP/IP协议, UDP/IP协议, 网络四层架构, 网路七层架构
category: tech
tags: ["网络", "原理"]
---

# HTTPS
Hyper Text Transfer Protocol over Secure Socket Layer.
HTTPS要使客户端与服务器端的通信过程得到安全保证，必须使用对称加密算法，
但是协商对称加密算法的过程，
需要使用非对称加密算法来保证安全，然而直接使用非对称加密的过程本身也不安全，
会有中间人篡改公钥的可能性，所以客户端与服务器不直接使用公钥，
而是使用数字证书签发机构颁发的证书来保证非对称加密过程本身的安全。
这样通过这些机制协商出一个对称加密算法，就此双方使用该算法进行加密解密。
从而解决了客户端与服务器端之间的通信安全问题。

## 特点
- 使用非对称加密进行对称秘钥的协商
- 使用对称秘钥加密内容
- 主要威胁: 中间人攻击
- 在tcp/ip四层协议基础上, 在http和tcp之间加一层ssl加密层.

## 非对称加密
- 私钥加密->公钥解密
- 公钥加密->私钥解密
- 私钥只能一个人有
- 公钥可以对外布

## 第三方机构存在的原因
- 客户端直接请求服务端公钥, 可能导致中间人调包, 中间人直接给客户端自己的公钥.
- 客户端数据用自己的私钥解密, 服务端的数据用截获的服务端的公钥解密
- 现实中, 所有浏览器和操纵系统都会维护一个权威的第三方机构列表,包括它们的公钥

## 数字证书
> 数字证书是一个经证书授权中心数字签名的包含公开密钥拥有者信息以及公开密钥的文件.
- 使用第三方机构的私钥加密的服务端的公钥
- 客户端安装第三方机构的公钥
### 数字证书的原理
1. CA机构使用自己的私钥加密服务端的公钥等网站认证信息, 并将证书给服务端保存
    - 其中包括了对整个认证内容的摘要加密值
2. 客户端发起请求
3. 服务端返回CA证书
4. 客户端拿到CA证书, 使用第三方认证机构的公钥解密
    - 并且计算摘要值是否与数字证书的一致
    - 这两个操作解决两个问题: 1. 数字证书只能是认证机构发放的, 2. 证书内容没有被篡改过
5. 验证证书是否有效

### 如何证明该证书就是该Server和CA签署的?
- 可信的时钟服务.
    - 过程: 用户将需要加密的文件使用哈希编码加密生成摘要
    - 将摘要发送的DTS
    - DTS对收到摘要的时间以及摘要做加密(数字签名)
    - 时间戳是一个经加密后形成的凭证文档

## 摘要算法
- 从大块数据中提取摘要, 内容变动导致摘要变动
- 摘要不会吐露任何最初明文的信息

## 性能问题
- http3次握手, https 还需要加上9次ssl握手, 共12个包
- 建立连接后加密方式为:3DES等对称秘钥加密, 相对CPU负荷较少

![Https首次请求介绍](/images/tech/https-connect.jpg)
> 解析
1. 3次握手建立tcp连接, 1个rtt
2. 服务返回302跳转https, 1个rtt
3. 3次握手重新建立tcp连接, 1个rtt
4. tls握手第一个阶段, 至少1个rtt
    - 服务端和浏览器协商秘钥交换算法/对称加密算法/内容一致性hash算法/证书签名算法/
    - A: (我这里的对称加密算法有:DES/RC5, 密钥交换算法有RSA/DH, 摘要算法有MD5和SHA), B: 那就用DES-RSA-SHA这对组合好了.
    - 浏览器校验证书是否有效
5. 解析CA站点的DNS, 一个rtt
    - 浏览器获取证书,可能会发起OCSP或CRL请求,查询证书状态
6. 3次握手与CAR站点建立tcp连接, 1个rtt
7. 发起OCSP请求,获取响应, 1个rtt
8. tls握手第二阶段, 秘钥协商, 1个rtt
9. 浏览器与服务器进行应用层数据加密传输




## App Transport Security

# CDN 技术
> 通过权威DNS服务器实现优质节点选择,通过缓存减少源站压力.

## 技术要点
- 运营商DNS为local dns
- 自建DNS服务器(权威服务器)
- 返回与local dns IP地址相近的CDN服务器IP地址
- http缓存服务器(减少回源压力)

## 阿里一个CDN节点
![一个CDN节点的架构设计图](/images/tech/cdn.jpg)
> 简介
- LVS是四层负载均衡组件
- Tengine是阿里在Nginx基础上开发的服务器, 做一致性hash
- swift缓存回源
- 主要缓存: 内存缓存/SSD缓存/SATA缓存

